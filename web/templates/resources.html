<!DOCTYPE html>
<html>
	<head>
		<title>everytiān Edit</title>
		<meta name="mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
    	<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.6.0/slick.css"/>
 		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.6.0/slick-theme.css"/>
		<style>
			.text {
				outline: none;
				font-size: 30pt;
			}

			.translation {
				outline: none;
				margin: 10pt 0pt;
			}

			.text .word{
				margin-right: 5pt;
			}

			.confirm, .edit, .finish {
				display: none;
			}
			.drag {
 				outline: none;
 				border: none;
 			}
		</style>
	</head>
	<body>
		<div id="carru" data-slick='{"slidesToShow": 1, "slidesToScroll": 2}'>


		</div>
		<div class="explain" style="display: none;">
			<div class="word"></div>
			<div class="pronunciation"></div>
			<ul class="definition"></ul>
		</div>
		{% csrf_token %}
		<script   src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.6.0/slick.js"></script>
		<script>
			
			text_elem = $("#text")
			translation_elem = $("#translation")
			// For a given user u
			// while true:
			// 	get next resource
			// 		render next resource

			var resource_id = null;
			base_url = 'http://www.everytian.com/api/resources'
			var dict = {};
			var edition = "";
			added_slicks = 0;
			

			$("#carru").slick({
   				speed: 300,
   				accessibility: false,
   				arrows: false,
   				infinite: false
 			});

			$('#carru').on('afterChange', next_resource);
 			
 			get_next();
 			get_next();
 			current_slide_index = 0

 			function next_resource(event, slick, currentSlide){
			  if(current_slide_index + 2 <= currentSlide){
			  	console.log(currentSlide);
			  	get_next();
			  	$("#carru").slick('slickRemove', 0);
			  	$("#carru").slick('slickRemove', 0);
			  }
			  // $("#carru").slick('slickRemove', currentSlide - 1);

			}

			function get_next() {
				var resource = $('<div class="resource drag"></div>');
				var text = $('<div class="text"></div>');
				var translation = $('<div class="translation"></div>');
				
				var edit = $('<button id="edit">Edit</button>').click(function(evt) {
					$(evt.target).hide();
					text.text(text.data("string"));
					text.attr('contenteditable','true');
					translation.attr('contenteditable','true');
					// deactivate draggable
			  		finish.show();
				});

				var finish = $('<button id="finish">Finish</button>').hide().click(function(evt) {
					finish.hide();
					text.data("string", text.text())
			  		var words = text.text().split(' ');
			  		show_words(words, text);
			  		get_definitions(words, dict);
					text.attr('contenteditable','false');
					translation.attr('contenteditable','false');
			  		edit.show();
			  		// activate draggable
			  		confirm.show();
			  	});

				var confirm = $('<button id="confirm">Confirm Edition</button>').hide().click(function(evt) {
						new_text = {
							"text": text.data("string").split(' '),
							"translation": translation.text(),
							'csrfmiddlewaretoken': $( "[name='csrfmiddlewaretoken']" ).val()
						}
						confirm.text("Sending...")
					$.post(base_url + '/' + resource.data("id"), new_text, function(response) {
						edit.show();
						confirm.text("Confirm")
						confirm.hide();

					}, 'json');
				});
				resource.append(text).append(translation);
				resource.append(edit).append(finish).append(confirm);

				$.getJSON( base_url, function( data ) {
					resource.data("id", data["id"]);
					text.data("string", data["text"].join(" "));
					show_words(data["text"], text);
					get_definitions(data["text"], dict)
					translation.text(data["translation"]);
					// if(data["audio"]){
					// 	place.find("#audio_container").append('<audio controls autoplay><source src="https://audio.tatoeba.org/sentences/cmn/' + data["audio"] + '.mp3" type="audio/mpeg">Your browser does not support audio!</audio>');
					// }
					words = data["words"];
					for(i in words){
						dict[words[i]['hanzi']] = {
							'pronunciation': words[i]['pinyin'],
							'definitions': words[i]['definitions']
						}
					}
					if(added_slicks > 0){
						$("#carru").slick('slickAdd', "<div></div>");
					} 
					$("#carru").slick('slickAdd', resource);
					added_slicks += 1;
			  	});
		  	}

			

			function show_words(words, jQ_div){
				jQ_div.empty();
		  		for(i in words) {
					 new_word = $('<span class="word">'+ words[i] + '</span>').click(on_word_click);
					 jQ_div.append(new_word);
		  		};

			}

			function get_definitions(words, dictionary){
				var punctuation = '…！？／（）、，。：「」…『』！？《》“”；’ ‘【】·〔〕.,?!-[]';

				for(i in words) { 
				 	if (!dictionary[words[i]] && !punctuation.includes(words[i])) {
				 		$.getJSON( 'http://www.everytian.com/api/words/' + words[i], function(word) {
							if(word['hanzi']){
								dictionary[word['hanzi']] = {
									'pronunciation': word['pinyin'],
									'definitions': word['definitions']
								}
							} else {
								console.log(word['warning']);
							}
						});
					}
				}
			}

			// Explain

			function explain(word, pronunciation, definitions){
		  		$( ".explain").hide();
				$( ".explain .word" ).text(word);
				$( ".explain .pronunciation" ).text(pronunciation);
				def_list = $( ".explain .definition" ).empty();
				for(var i = 0; i < definitions.length; i++){
					def_list.append("<li>" + definitions[i] + "</li>");	
				};
				$( ".explain").show();
				// $("#corrector").height($( ".explain").height());
			}

			var last_touched="";

			function clear_explain(){
				$( ".explain .word" ).empty();
				$( ".explain .pronunciation" ).empty();
				$( ".explain .definition" ).empty();
			  	$( ".explain").hide();
				// $("#corrector").height(0);
			}

			function on_word_click(event) {
			  touched_word = $(this).text()
			  if(touched_word in dict) {
			  	if (last_touched == touched_word){
			  		if ($(this).hasClass( "unknown" )){
			  			$(this).removeClass( "unknown" );
			  			// $(this).next().prop('checked', false).next().hide();
			  			clear_explain();
			  		} else {
			  			word_dict = dict[touched_word];
			  			explain(touched_word, word_dict["pronunciation"], word_dict["definitions"]);
			  			$(this).addClass( "unknown" );
			  			// $(this).next().prop('checked', true).next().show();
			  		}
			  	} else {
			  		word_dict = dict[touched_word];
			  		explain(touched_word, word_dict["pronunciation"], word_dict["definitions"]);
			  		if (!$(this).hasClass("unknown")){
			  			$(this).addClass("unknown");
			  			// $(this).next().prop('checked', true).next().show();
			  		}
			  	};
			  	last_touched = touched_word;
			  }
			};

		</script>
	</body>
</html>